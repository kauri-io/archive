<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://kauri.io/collections/Build%20your%20very%20own%20self-hosting%20platform%20with%20Raspberry%20Pi%20and%20Kubernetes/%2868%29-self-host-pi-hole-on-kubernetes-and-block-ad/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>(6/8) Self-host Pi-Hole on Kubernetes and block ads and trackers at the network level - kauri.io</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "(6/8) Self-host Pi-Hole on Kubernetes and block ads and trackers at the network level", url: "#_top", children: [
              {title: "This article is part of the series Build your very own self-hosting platform with Raspberry Pi and Kubernetes", url: "#this-article-is-part-of-the-series-build-your-very-own-self-hosting-platform-with-raspberry-pi-and-kubernetes" },
              {title: "Introduction", url: "#introduction" },
              {title: "Prerequisite", url: "#prerequisite" },
              {title: "Namespace", url: "#namespace" },
              {title: "Persistence", url: "#persistence" },
              {title: "Deployment", url: "#deployment" },
              {title: "Ingress", url: "#ingress" },
              {title: "Result", url: "#result" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-172017815-1', 'kauri.io');
        ga('send', 'pageview');
    </script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h1 id="68-self-host-pi-hole-on-kubernetes-and-block-ads-and-trackers-at-the-network-level">(6/8) Self-host Pi-Hole on Kubernetes and block ads and trackers at the network level</h1>
<p><img alt="" src="https://ipfs.infura.io/ipfs/QmbJb9BztkrFe8ejvxSjkYxwLH79oA7388GEHLQPbqkwnC" /></p>
<p><br /></p>
<h4 id="this-article-is-part-of-the-series-build-your-very-own-self-hosting-platform-with-raspberry-pi-and-kubernetes">This article is part of the series <a href="https://kauri.io/build-your-very-own-self-hosting-platform-with-raspberry-pi-and-kubernetes/5e1c3fdc1add0d0001dff534/c">Build your very own self-hosting platform with Raspberry Pi and Kubernetes</a></h4>
<ol>
<li><a href="https://kauri.io/build-your-very-own-self-hosting-platform-with-raspberry-pi-and-kubernetes-introduction/1229f21044ef4bff8df35875d6803776/a">Introduction</a></li>
<li><a href="https://kauri.io/install-raspbian-operating-system-and-prepare-the-system-for-kubernetes/7df2a9f9cf5f4f6eb217aa7223c01594/a">Install Raspbian Operating-System and prepare the system for Kubernetes</a></li>
<li><a href="https://kauri.io/install-and-configure-a-kubernetes-cluster-with-k3s-to-self-host-applications/418b3bc1e0544fbc955a4bbba6fff8a9/a">Install and configure a Kubernetes cluster with k3s to self-host applications</a></li>
<li><a href="https://kauri.io/deploy-nextcloud-on-kuberbetes:-the-self-hosted-dropbox/f958350b22794419b09fc34c7284b02e/a">Deploy NextCloud on Kuberbetes: The self-hosted Dropbox</a></li>
<li><a href="https://kauri.io/self-host-your-media-center-on-kubernetes-with-plex-sonarr-radarr-transmission-and-jackett/8ec7c8c6bf4e4cc2a2ed563243998537/a">Self-host your Media Center On Kubernetes with Plex, Sonarr, Radarr, Transmission and Jackett</a></li>
<li><strong>Self-host Pi-Hole on Kubernetes and block ads and trackers at the network level</strong></li>
<li><a href="https://kauri.io/selfhost-your-password-manager-with-bitwarden/b2187730d4294626b28d1d938057e2e0/a">Self-host your password manager with Bitwarden</a></li>
<li><a href="https://kauri.io/deploy-prometheus-and-grafana-to-monitor-a-kube/186a71b189864b9ebc4ef7c8a9f0a6b5/a">Deploy Prometheus and Grafana to monitor a Kubernetes cluster</a></li>
</ol>
<p><br />
<br /></p>
<h3 id="introduction">Introduction</h3>
<p>Pi Hole is a network-wide ad blocker. In a typical home environment, this can cut out almost all ads to all devices in your home, without having to install an ad blocker on every single device. Technically Pi-Hole acts as a DNS sinkhole which filters out unwanted results using a blacklist domains list. Pi-Hole also offers a great admin interface to configure and analyse your network traffic (DNS, DHCP, Black/White list, regex, etc.).</p>
<p><img alt="" src="https://ipfs.infura.io/ipfs/QmWNdkLpvCo2aHjAL3k45vndybyv6u1aM5wTZw9UgeXZsB" /></p>
<p>In this new article, we will learn how to deploy Pi-Hole on a Kubernetes self-hosting platform.</p>
<p><br />
<br /></p>
<h3 id="prerequisite">Prerequisite</h3>
<p>In order to run entirely the tutorial, we will need:</p>
<ul>
<li>A running Kubernetes cluster (see previous articles if you haven't set this up yet)</li>
<li>Access to your router admin console to configure Pi-Hole as DNS or disable DHCP (replaced by Pi-Hole)</li>
</ul>
<p><br /> 
<br /></p>
<h3 id="namespace">Namespace</h3>
<p>We are going to isolate all the Kubernetes objects related to Pi-Hole in the namespace <code>pihole</code>.</p>
<p>To create a namespace, run the following command:</p>
<pre><code>$ kubectl create namespace pihole
</code></pre>
<p><br />
<br /></p>
<h3 id="persistence">Persistence</h3>
<p>The first step consists in setting up a volume to store the Pi-Hole config files and data. If you followed the previous articles to install and configure a self-hosting platform using RaspberryPi and Kubernetes, you remember we have on each worker a NFS client pointing to a SSD on <code>/mnt/ssd</code>.</p>
<p><strong>1. Deploy the Persistent Volume (PV)</strong></p>
<p>The Persistent Volume specify the name, the size, the location and the access modes of the volume:</p>
<ul>
<li>The name of the PV is  <code>pihole</code></li>
<li>The size allocated is 500MB</li>
<li>The location is <code>/mnt/ssd/pihole</code></li>
<li>The access is ReadWriteOnce</li>
</ul>
<p>Create the following file and apply it to the k8 cluster.</p>
<pre><code class="language-yaml">## pihole.persistentvolume.yml
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: &quot;pihole&quot;
  labels:
    type: &quot;local&quot;
spec:
  storageClassName: &quot;manual&quot;
  capacity:
    storage: &quot;500Mi&quot;
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: &quot;/mnt/ssd/pihole&quot;
---
</code></pre>
<pre><code>$ kubectl apply -f pihole.persistentvolume.yml
persistentvolume/pihole created
</code></pre>
<p>You can verify the PV exists with the following command:</p>
<pre><code>$ kubectl get pv

NAME            CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
pihole          500Mi      RWO            Retain           Available           manual                  34s
</code></pre>
<p><br />
<strong>2. Create the Persistent Volume Claim (PVC)</strong></p>
<p>The Persistent Volume Claim is used to map a Persistent Volume to a deployment or stateful set. Unlike the PV, the PVC belongs to a namespace.</p>
<p>Create the following file and apply it to the k8 cluster.</p>
<pre><code class="language-yaml">## pihole.persistentvolumeclaim.yml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  namespace: &quot;pihole&quot;
  name: &quot;pihole&quot;
spec:
  storageClassName: &quot;manual&quot;
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: &quot;500Mi&quot;
---
</code></pre>
<pre><code>$ kubectl apply -f pihole.persistentvolumeclaim.yml
persistentvolumeclaim/pihole created
</code></pre>
<p>You can verify the PVC exists with the following command:</p>
<pre><code>$ kubectl get pvc -n pihole

NAME            STATUS   VOLUME          CAPACITY   ACCESS MODES   STORAGECLASS   AGE
pihole          Bound    pihole          500Mi      RWO            manual         26s
</code></pre>
<p><br />
<br /></p>
<h3 id="deployment">Deployment</h3>
<p>In the next part, we are now going to deploy Pi-Hole using a modified version open-source Helm chart <a href="https://github.com/MoJo2600/pihole-kubernetes">pihole-kubernetes</a>.</p>
<p><strong>1. Install the repo </strong></p>
<pre><code>$ helm repo add mojo2600 https://mojo2600.github.io/pihole-kubernetes/ &amp;&amp; helm repo update
</code></pre>
<p><br />
<strong>2. Create a secret to store Pi-Hole admin password</strong></p>
<p>Replace <code>&lt;ADMIN_PASSWORD&gt;</code> by the password of your choice. This password will be used to connect to the Pi-Hole administration interface.</p>
<pre><code>$ kubectl create secret generic pihole-secret \
    --from-literal password=&lt;ADMIN_PASSWORD&gt; \
    --namespace pihole
</code></pre>
<p><br />
<strong>3. Download the Chart values of the chart locally</strong></p>
<p>Run the following command to download the Chart values into the local file <code>pihole.values.yml</code>.</p>
<pre><code>$ helm show values mojo2600/pihole &gt;&gt; pihole.values.yml
</code></pre>
<p>If you open the file, you will see the default configuration values to setup Pi-Hole. Instead of using the flag <code>--set property=value</code> like before, we will use the file <code>pihole.values.yml</code> to make all the changes.</p>
<p><br />
<strong>4. Update the values</strong></p>
<p>We now need to update a few properties before installing the Helm chart. Open the file <code>pihole.values.yml</code> and change the following properties (<em>replace the information surrounded by <brackets> with your information</em>).</p>
<pre><code class="language-yaml">## pihole.values.yml

(...)

persistentVolumeClaim:
  # set to true to use pvc
  enabled: true # Change to true
  # set to true to use you own pvc
  existingClaim: &quot;pihole&quot; # Name of the persistent volume claim

(...)

extraEnvVars:
  TZ: &quot;Europe/London&quot; # Timezone
  ServerIP: 192.168.0.22 # Add the master node IP only if your configure `hostNetwork: true` (next paragraph, point b only)

(...)

## Use an existing secret for the admin password.
admin:
  existingSecret: &quot;pihole-secret&quot; # Reference to the secret created step 2
  passwordKey: &quot;password&quot;
</code></pre>
<p><br />
The network config might be different if your need to get DHCP working with Pi-hole.</p>
<p>a. I can override my router default DNS config</p>
<pre><code class="language-yaml">## pihole.values.yml

(...)

serviceTCP:
  type: LoadBalancer # Configure MetalLB to used a dedicated &quot;virtual&quot; IP to expose the DNS server
  annotations:
    metallb.universe.tf/allow-shared-ip: pihole-svc

serviceUDP:
  type: LoadBalancer # Configure MetalLB to used a dedicated &quot;virtual&quot; IP to expose the DNS server
  annotations:
    metallb.universe.tf/allow-shared-ip: pihole-svc
</code></pre>
<p>b. I can't override my router DNS config and I need to enable DHCP on Pi-Hole (disable on my router) to force the devices to use Pi-Hole as DNS.</p>
<p>In this case, we are going to use the flag <code>hostNetwork=true</code> and <code>privileged=true</code> to let the pod use the node network with root privilege which will enable DHCP through network broadcast on port 67 (<a href="https://docs.pi-hole.net/docker/DHCP/">more info</a>).</p>
<pre><code class="language-yaml">## pihole.values.yml

(...)

serviceTCP:
  type: ClusterIP

serviceUDP:
  type: ClusterIP

(...)

hostNetwork: &quot;true&quot; # The pod uses the host network rather than k8s network (to perform a network broadcast on port 67 / DHCP) See  https://docs.pi-hole.net/docker/DHCP/#docker-pi-hole-with-host-networking-mode
privileged: &quot;true&quot; # Give root permission to the pod on the host
webHttp: &quot;55080&quot; # Random HTTP port to prevent clash (because the pod will be on the host network)
webHttps: &quot;55443&quot; # Random HTTPS port to prevent clash (because the pod will be on the host network)
</code></pre>
<p><br />
<strong>4. Install the Chart</strong></p>
<p>In the part, we will install the Helm chart under the namespace <code>pihole</code> with <code>pihole.values.yml</code> as configuration file.</p>
<pre><code>$ helm install pihole mojo2600/pihole \
  --namespace pihole \
  --values pihole.values.yml
</code></pre>
<p>After a couple of minutes, check if the pod and service is up and running:</p>
<pre><code>$ kubectl get pods -n pihole -o wide

NAME                      READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES
pihole-695f4bd7c8-xwswq   1/1     Running   1          45m   192.168.0.22   kube-master   &lt;none&gt;           &lt;none&gt;
</code></pre>
<pre><code>$ kubectl get services -n pihole -o wide

NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                 AGE   SELECTOR
pihole-tcp   ClusterIP   10.43.35.133   &lt;none&gt;        80/TCP,443/TCP,53/TCP   45m   app=pihole,release=pihole
pihole-udp   ClusterIP   10.43.96.245   &lt;none&gt;        53/UDP,67/UDP           45m   app=pihole,release=pihole
</code></pre>
<p><br />
<br /></p>
<h3 id="ingress">Ingress</h3>
<p>To access Pi-Hole admin, we are now going to deploy an Ingress, responsible of making accessible a service from outside the cluster by mapping an internal <code>service:port</code> to a host. To choose a host, we need to configure a DNS like we did for NextCloud "nextcloud.<domain.com>" in the previous article. However, unlike NextCloud, Pi-Hole have no reason to be exposed on the Internet, we can pick a host that will be resolved internally to our Nginx proxy (available at <code>192.168.0.240</code> : LoadBalancer IP). The simplest solution is to use <a href="https://nip.io">nip.io</a> which allows us to map an IP (in our case <code>192.168.0.240</code>) to a hostname without touching <code>/etc/hosts</code> or configuring a DNS. Basically it resolves <code>&lt;anything&gt;.&lt;ip&gt;.nip.io</code> by <code>&lt;ip&gt;</code> without requiring anything else, Magic !</p>
<p><strong>1. Create the file <code>pihole.ingress.yml</code></strong></p>
<p>Create the following Ingress config file <code>pihole.ingress.yml</code> to map the route <code>/</code> to Pi-Hole HTTP service:</p>
<pre><code class="language-yaml">## pihole.ingress.yml
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  namespace: pihole
  name: pihole-ingress
  annotations:
    kubernetes.io/ingress.class: &quot;nginx&quot;
spec:
  rules:
  - host: pihole.192.168.0.240.nip.io
    http:
      paths:
        - path: /
          backend:
            serviceName: pihole-tcp
            servicePort: 8000
---
</code></pre>
<p><br />
<strong>2. Deploy the ingress</strong></p>
<p>Deploy the Ingress by applying the file <code>pihole.ingress.yaml</code>.</p>
<pre><code>$ kubectl apply -f pihole.ingress.yaml
ingress.extensions/pihole-ingress created
</code></pre>
<p><br />
<br /></p>
<h3 id="result">Result</h3>
<p>You can now access Pi-Hole via <a href="http://pihole.192.168.0.240.nip.io/admin">pihole.192.168.0.240.nip.io/admin</a>.</p>
<p><img alt="" src="https://i.imgur.com/FlgpGwV.png" /></p>
<p>Click on <strong>Login</strong> on the left menu and enter the password configured earlier in <code>pihole.values.yml</code>.</p>
<p>If you configured Pi-Hole to be used as DHCP server, you need to go to <strong>Settings / DHCP</strong>, enable DHCP, configure the IP range and the IP of your network router.</p>
<p><img alt="" src="https://i.imgur.com/O4BKu8a.png" /></p>
<p><br />
<br /></p>
<hr />
<ul>
<li><strong>Kauri original title:</strong> (6/8) Self-host Pi-Hole on Kubernetes and block ads and trackers at the network level</li>
<li><strong>Kauri original link:</strong> https://kauri.io/68-selfhost-pihole-on-kubernetes-and-block-ads-and/5268e3daace249aba7db0597b47591ef/a</li>
<li><strong>Kauri original author:</strong> Gr√©goire Jeanmart (@gregjeanmart)</li>
<li><strong>Kauri original Publication date:</strong> 2020-07-29</li>
<li><strong>Kauri original tags:</strong> self-hosting, kubernetes, pi-hole, dns, ad-blocker, dhcp</li>
<li><strong>Kauri original hash:</strong> QmcxZpL77o7Dpkz2xrNpdgUzGUyEc2UvqoM3dafKNcE5K1</li>
<li><strong>Kauri original checkpoint:</strong> unknown</li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%2878%29-self-host-your-password-manager-with-bitward/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%2878%29-self-host-your-password-manager-with-bitward/" class="btn btn-xs btn-link">
        (7/8) Self-host your password manager with Bitwarden
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%2858%29-self-host-your-media-center-on-kubernetes-wi/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%2858%29-self-host-your-media-center-on-kubernetes-wi/" class="btn btn-xs btn-link">
        (5/8) Self-host your Media Center On Kubernetes with Plex, Sonarr, Radarr, Transmission and Jackett
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/kauri-io/archive/edit/master/docs/collections/Build your very own self-hosting platform with Raspberry Pi and Kubernetes/(68)-self-host-pi-hole-on-kubernetes-and-block-ad.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>